rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Artifacts - main app data
    match /artifacts/{appId} {
      
      // Public data (stores and stock entries)
      match /public/data/{document=**} {
        // Allow read/write for authenticated users
        allow read, write: if isAuthenticated();
      }
      
      // User collection - allow read access to check if users exist
      match /users/{userId} {
        // Allow read access to check if any users exist (for first user detection)
        allow read: if true;
        
        // Allow authenticated users to write their own data
        allow write: if isAuthenticated();
        
        match /user_config/profile {
          // Allow any authenticated user to write profiles (for first setup)
          allow read, write: if isAuthenticated();
        }
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}